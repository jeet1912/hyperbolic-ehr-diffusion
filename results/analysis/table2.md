Using device: mps
[MIMIC] Loading data/mimic_hf_cohort.pkl ...
[MIMIC] Patients: 7397 | Vocab size: 4817
[HyperMedDiff-Risk] Real trajectory stats: {
  "patients": 7397,
  "avg_visits_per_patient": 1.7,
  "avg_codes_per_visit": 424.04,
  "max_visits": 12,
  "max_codes": 9261
}
[Pretrain] Epoch 01 | train=0.0036 | val=0.0033
[Pretrain] Epoch 02 | train=0.0033 | val=0.0031
[Pretrain] Epoch 03 | train=0.0031 | val=0.0029
[Pretrain] Epoch 04 | train=0.0029 | val=0.0027
[Pretrain] Epoch 05 | train=0.0027 | val=0.0026
[Pretrain] Epoch 06 | train=0.0026 | val=0.0025
[Pretrain] Epoch 07 | train=0.0025 | val=0.0024
[Pretrain] Epoch 08 | train=0.0024 | val=0.0023
[Pretrain] Epoch 09 | train=0.0023 | val=0.0023
[Pretrain] Epoch 10 | train=0.0023 | val=0.0022
[Pretrain] Epoch 11 | train=0.0022 | val=0.0022
[Pretrain] Epoch 12 | train=0.0022 | val=0.0022
[Pretrain] Epoch 13 | train=0.0022 | val=0.0022
[Pretrain] Epoch 14 | train=0.0022 | val=0.0022
[Pretrain] Epoch 15 | train=0.0022 | val=0.0022
[Pretrain] Epoch 16 | train=0.0022 | val=0.0022
[Pretrain] Epoch 17 | train=0.0022 | val=0.0022
[Pretrain] Epoch 18 | train=0.0021 | val=0.0022
[Pretrain] Epoch 19 | train=0.0021 | val=0.0022
[Pretrain] Epoch 20 | train=0.0021 | val=0.0021
[Pretrain] Epoch 21 | train=0.0021 | val=0.0021
[Pretrain] Epoch 22 | train=0.0021 | val=0.0021
[Pretrain] Epoch 23 | train=0.0021 | val=0.0021
[Pretrain] Epoch 24 | train=0.0021 | val=0.0021
[Pretrain] Epoch 25 | train=0.0021 | val=0.0021
[Pretrain] Epoch 26 | train=0.0021 | val=0.0021
[Pretrain] Epoch 27 | train=0.0021 | val=0.0021
[Pretrain] Epoch 28 | train=0.0021 | val=0.0021
[Pretrain] Epoch 29 | train=0.0021 | val=0.0021
[Pretrain] Epoch 30 | train=0.0021 | val=0.0021
[HyperMedDiff-Risk] Diffusion/embedding correlation after pretraining: 0.8492
[HyperMedDiff-Risk] Epoch 001 | Train 13.5785 | Val 10.9458
[HyperMedDiff-Risk] Epoch 002 | Train 11.3399 | Val 10.7893
[HyperMedDiff-Risk] Epoch 003 | Train 11.0380 | Val 10.3122
[HyperMedDiff-Risk] Epoch 004 | Train 10.4299 | Val 9.4800
[HyperMedDiff-Risk] Epoch 005 | Train 9.7412 | Val 8.6953
[HyperMedDiff-Risk] Epoch 006 | Train 9.0762 | Val 7.9500
[HyperMedDiff-Risk] Epoch 007 | Train 8.5286 | Val 7.4067
[HyperMedDiff-Risk] Epoch 008 | Train 8.0458 | Val 6.8993
[HyperMedDiff-Risk] Epoch 009 | Train 7.6389 | Val 6.4241
[HyperMedDiff-Risk] Epoch 010 | Train 7.2718 | Val 6.0905
[HyperMedDiff-Risk] Epoch 011 | Train 6.9437 | Val 5.6907
[HyperMedDiff-Risk] Epoch 012 | Train 6.6829 | Val 5.4826
[HyperMedDiff-Risk] Epoch 013 | Train 6.4115 | Val 5.2231
[HyperMedDiff-Risk] Epoch 014 | Train 6.2162 | Val 5.0198
[HyperMedDiff-Risk] Epoch 015 | Train 5.9926 | Val 4.7301
[HyperMedDiff-Risk] Epoch 016 | Train 5.8150 | Val 4.5918
[HyperMedDiff-Risk] Epoch 017 | Train 5.6448 | Val 4.4513
[HyperMedDiff-Risk] Epoch 018 | Train 5.4604 | Val 4.2053
[HyperMedDiff-Risk] Epoch 019 | Train 5.3497 | Val 4.1079
[HyperMedDiff-Risk] Epoch 020 | Train 5.1907 | Val 3.8761
[HyperMedDiff-Risk] Epoch 021 | Train 5.0607 | Val 3.8165
[HyperMedDiff-Risk] Epoch 022 | Train 4.9349 | Val 3.6805
[HyperMedDiff-Risk] Epoch 023 | Train 4.8414 | Val 3.4951
[HyperMedDiff-Risk] Epoch 024 | Train 4.6788 | Val 3.4374
[HyperMedDiff-Risk] Epoch 025 | Train 4.6100 | Val 3.4187
[HyperMedDiff-Risk] Epoch 026 | Train 4.5155 | Val 3.2806
[HyperMedDiff-Risk] Epoch 027 | Train 4.4438 | Val 3.1726
[HyperMedDiff-Risk] Epoch 028 | Train 4.3356 | Val 3.0545
[HyperMedDiff-Risk] Epoch 029 | Train 4.2604 | Val 3.0119
[HyperMedDiff-Risk] Epoch 030 | Train 4.2033 | Val 2.9304
[HyperMedDiff-Risk] Epoch 031 | Train 4.1497 | Val 2.9468
[HyperMedDiff-Risk] Epoch 032 | Train 4.0709 | Val 2.8089
[HyperMedDiff-Risk] Epoch 033 | Train 3.9829 | Val 2.7409
[HyperMedDiff-Risk] Epoch 034 | Train 3.9091 | Val 2.7253
[HyperMedDiff-Risk] Epoch 035 | Train 3.8497 | Val 2.6996
[HyperMedDiff-Risk] Epoch 036 | Train 3.8736 | Val 2.6004
[HyperMedDiff-Risk] Epoch 037 | Train 3.8186 | Val 2.6021
[HyperMedDiff-Risk] Epoch 038 | Train 3.7272 | Val 2.5776
[HyperMedDiff-Risk] Epoch 039 | Train 3.7179 | Val 2.4348
[HyperMedDiff-Risk] Epoch 040 | Train 3.6428 | Val 2.4188
[HyperMedDiff-Risk] Epoch 041 | Train 3.6224 | Val 2.4536
[HyperMedDiff-Risk] Epoch 042 | Train 3.5951 | Val 2.3920
[HyperMedDiff-Risk] Epoch 043 | Train 3.5715 | Val 2.3771
[HyperMedDiff-Risk] Epoch 044 | Train 3.5296 | Val 2.3697
[HyperMedDiff-Risk] Epoch 045 | Train 3.4946 | Val 2.2808
[HyperMedDiff-Risk] Epoch 046 | Train 3.4626 | Val 2.2942
[HyperMedDiff-Risk] Epoch 047 | Train 3.4786 | Val 2.2313
[HyperMedDiff-Risk] Epoch 048 | Train 3.3984 | Val 2.2284
[HyperMedDiff-Risk] Epoch 049 | Train 3.3522 | Val 2.1764
[HyperMedDiff-Risk] Epoch 050 | Train 3.3296 | Val 2.1660
[HyperMedDiff-Risk] Epoch 051 | Train 3.3170 | Val 2.1192
[HyperMedDiff-Risk] Epoch 052 | Train 3.3174 | Val 2.1440
[HyperMedDiff-Risk] Epoch 053 | Train 3.2758 | Val 2.0839
[HyperMedDiff-Risk] Epoch 054 | Train 3.2297 | Val 2.1493
[HyperMedDiff-Risk] Epoch 055 | Train 3.2260 | Val 2.0602
[HyperMedDiff-Risk] Epoch 056 | Train 3.2183 | Val 2.0886
[HyperMedDiff-Risk] Epoch 057 | Train 3.2252 | Val 2.0405
[HyperMedDiff-Risk] Epoch 058 | Train 3.2177 | Val 2.0724
[HyperMedDiff-Risk] Epoch 059 | Train 3.1636 | Val 2.0249
[HyperMedDiff-Risk] Epoch 060 | Train 3.1525 | Val 1.9489
[HyperMedDiff-Risk] Epoch 061 | Train 3.1577 | Val 2.0149
[HyperMedDiff-Risk] Epoch 062 | Train 3.1384 | Val 2.0100
[HyperMedDiff-Risk] Epoch 063 | Train 3.1539 | Val 2.0131
[HyperMedDiff-Risk] Epoch 064 | Train 3.1002 | Val 2.0206
[HyperMedDiff-Risk] Epoch 065 | Train 3.0884 | Val 1.9575
[HyperMedDiff-Risk] Early stopping.
[HyperMedDiff-Risk] Best validation total loss: 1.9489
[HyperMedDiff-Risk] Saved training curve plot to results/plots/risk_prediction_mimic.png
[HyperMedDiff-Risk] Test risk metrics (MedDiffusion-style):
{
  "accuracy": 0.7533753375337534,
  "f1": 0.7175257731958763,
  "kappa": 0.5045506331174116,
  "auroc": 0.8711335962956611,
  "auprc": 0.7991663207496127
}
[HyperMedDiff-Risk] Diffusion/embedding correlation after training: 0.8385
Saved checkpoint to results/checkpoints/hypermeddiff_risk_best_1.9489.pt
